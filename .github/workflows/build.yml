name: Release Build
run-name: Building for ${{ github.ref_name }}
on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

jobs:
  vite-build:
    permissions:
      contents: read
    runs-on: ubuntu-24.04
    outputs:
      cache-key: ${{ steps.Store-Cache-Key.outputs.cache-key }}
    defaults:
      run:
        working-directory: ./front
    steps:
      - name: Check-out repository
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false
          package_json_file: 'front/package.json'

      - name: Use Node.js 24
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: "pnpm"
          cache-dependency-path: 'front/pnpm-lock.yaml'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Frontend
        run: pnpm run build

      - name: Store Cache Key
        id: Store-Cache-Key
        run: echo "cache-key=frontpage-dist-${{ hashFiles('page/**') }}" >> "$GITHUB_OUTPUT"

      - name: Cache
        uses: actions/cache@v4.2.1
        with:
          path: page
          key: ${{ steps.Store-Cache-Key.outputs.cache-key }}

  build:
    env:
      UV_INDEX: https://pypi.org/simple
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            platform: linux
            arch: x64

          - os: ubuntu-24.04-arm
            platform: linux
            arch: arm64

          - os: macos-15-intel
            platform: osx
            arch: x64

          - os: macos-15
            platform: osx
            arch: arm64

          - os: windows-2025
            platform: win
            arch: x64

          - os: windows-11-arm
            platform: win
            arch: arm64
    runs-on: ${{ matrix.os }}
    name: Build (${{ matrix.platform }}-${{ matrix.arch }})
    needs: vite-build

    steps:
      - name: Check-out repository
        uses: actions/checkout@v4

      - name: 'Workaround for missing zstd in windows-11-arm'
        if: matrix.os == 'windows-11-arm'
        run: choco install zstandard

      - name: Restore cached frontend artifacts
        uses: actions/cache@v4.2.1
        with:
          path: page
          key: ${{ needs.vite-build.outputs.cache-key }}
          enableCrossOsArchive: true
          fail-on-cache-miss: true

      - name: Setup ccache
        if: ${{ matrix.platform != 'win' }}
        uses: Chocobo1/setup-ccache-action@v1

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version-file: ".python-version"

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'updater/go.mod'
          cache-dependency-path: "updater/go.sum"

      - name: Install Dependencies
        run: uv sync

      - name: Setup Environment Variables
        shell: bash
        run: |
          echo "NUITKA_CACHE_DIR=${{ runner.temp }}/nuitka/cache" >> $GITHUB_ENV

      - name: Cache Nuitka cache directory
        uses: actions/cache@v4
        with:
          path: ${{ env.NUITKA_CACHE_DIR }}
          key: nuitka-${{ runner.os }}-${{ runner.arch }}-${{ github.sha }}
          restore-keys: |
            nuitka-${{ runner.os }}-${{ runner.arch }}-

      - name: Build Executable
        if: ${{ matrix.os == 'windows-11-arm' || matrix.os == 'windows-2025' }}
        run: uv run python -m nuitka --standalone --lto=no --windows-icon-from-ico=logo.jpg --assume-yes-for-downloads --user-package-configuration-file=nuitka-package.config.yml --output-dir=build --include-package=PIL --include-package=maa -o MWU main.py

      - name: Build Executable
        if: ${{ matrix.platform == 'linux' }}
        run: uv run python -m nuitka --standalone --lto=no --linux-icon=logo.jpg --assume-yes-for-downloads --user-package-configuration-file=nuitka-package.config.yml --output-dir=build --include-package=PIL --include-package=maa -o MWU main.py

      - name: Build Executable
        if: ${{ matrix.platform == 'osx' }}
        run: uv run python -m nuitka --standalone --lto=no --macos-app-icon=logo.jpg --assume-yes-for-downloads --user-package-configuration-file=nuitka-package.config.yml --output-dir=build --include-package=PIL --include-package=maa -o MWU main.py

      - name: Build Updater
        if: ${{ matrix.platform != 'win' }}
        shell: bash
        run: |
          pushd updater
          if [ "${{ matrix.arch }}" = "x64" ]; then
            ARCH=amd64
          else
            ARCH=arm64
          fi
          if [ "${{ matrix.platform }}" = "linux" ]; then
            GOOS=linux GOARCH=$ARCH go build -ldflags '-w -s' -o ../build/main.dist/mwu-updater .
          else
            GOOS=darwin GOARCH=$ARCH go build -ldflags '-w -s' -o ../build/main.dist/mwu-updater .
          fi
          popd

      - name: Build Updater
        if: ${{ matrix.platform == 'win' }}
        shell: pwsh
        run: |
          Push-Location updater
          if ("${{ matrix.arch }}" -eq "x64") {
            $env:GOOS = "windows"
            $env:GOARCH = "amd64"
          } else {
            $env:GOOS = "windows"
            $env:GOARCH = "arm64"
          }
          go build -ldflags '-w -s' -o ..\build\main.dist\mwu-updater.exe .
          Pop-Location

      - name: Copy Resources to Build
        shell: bash
        run: |
          cp -r "config" "build/main.dist/config"
          cp -r "page" "build/main.dist/page"
          git clone "https://github.com/MaaXYZ/MaaAgentBinary" "build/main.dist/MaaAgentBinary"

      - name: Create Version file
        run: echo "${{ github.ref_name }}" >> build/main.dist/version

      - name: Compress Build
        run: 7z a -t7z -mx=9 -mmt -ms -r MWU-${{ github.ref_name }}-${{ matrix.platform }}-${{ matrix.arch }}.7z "./build/main.dist/*"

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MWU-${{ github.ref_name }}-${{ matrix.platform }}-${{ matrix.arch }}
          path: MWU-${{ github.ref_name }}-${{ matrix.platform }}-${{ matrix.arch }}.7z

  release:
    if: ${{ startsWith(github.ref, 'refs/tags/') }}
    permissions:
      contents: write
    runs-on: ubuntu-24.04
    needs: build
    steps:
      - name: Check-out repository
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: MWU-${{ github.ref_name }}-*
          merge-multiple: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version-file: ".python-version"

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Generate Release Notes
        id: generate_notes
        env:
          API_KEY: ${{ secrets.SILICONFLOW_API_KEY }}
        run: uv run python .github/scripts/generate_release_notes.py

      - name: Create Release
        uses: ncipollo/release-action@v1.16.0
        with:
          draft: true
          allowUpdates: true
          artifacts: artifacts/*.7z
          body: ${{ steps.generate_notes.outputs.notes }}
          name: 'Release ${{ github.ref_name }}'
